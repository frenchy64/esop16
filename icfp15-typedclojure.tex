%-----------------------------------------------------------------------------
%
%               Template for sigplanconf LaTeX Class
%
% Name:         sigplanconf-template.tex
%
% Purpose:      A template for sigplanconf.cls, which is a LaTeX 2e class
%               file for SIGPLAN conference proceedings.
%
% Guide:        Refer to "Author's Guide to the ACM SIGPLAN Class,"
%               sigplanconf-guide.pdf
%
% Author:       Paul C. Anagnostopoulos
%               Windfall Software
%               978 371-2316
%               paul@windfall.com
%
% Created:      15 February 2005
%
%-----------------------------------------------------------------------------


\documentclass[preprint,9pt]{sigplanconf}

% The following \documentclass options may be useful:

% preprint      Remove this option only once the paper is in final form.
% 10pt          To set in 10-point type instead of 9-point.
% 11pt          To set in 11-point type instead of 9-point.
% authoryear    To obtain author/year citation style instead of numeric.

\usepackage{mmm}
\usepackage{mathpartir}
\usepackage{clj-grammar}
\usepackage{xcolor}
%\usepackage{url}
%\usepackage{biblatex}
\include{bibliography.bib}
\usepackage{framed}
\usepackage{enumitem}

\usepackage{listings}
\lstset{ %
  language=Lisp,                % choose the language of the code
  columns=fixed,basewidth=.5em,
  basicstyle=\small\ttfamily,       % the size of the fonts that are used for the code
  %numbers=left,                   % where to put the line-numbers
  %numberstyle=\small\ttfamily,      % the size of the fonts that are used for the line-numbers
  %stepnumber=1,                   % the step between two line-numbers. If it is 1 each line will be numbered
  %numbersep=5pt,                  % how far the line-numbers are from the code
  %backgroundcolor=\color{white},  % choose the background color. You must add \usepackage{color}
  %showspaces=false,               % show spaces adding particular underscores
  showstringspaces=false,         % underline spaces within strings
  %showtabs=false,                 % show tabs within strings adding particular underscores
  frame=single,           % adds a frame around the code
  %tabsize=2,          % sets default tabsize to 2 spaces
  captionpos=t,           % sets the caption-position to bottom
  breaklines=true,        % sets automatic line breaking
  breakatwhitespace=true,    % sets if automatic breaks should only happen at whitespace
  %escapeinside={\%*}{*)},          % if you want to add a comment within your code
}


\usepackage{amsmath}

\newcommand\smallsection[1]{\bf \emph{#1}}

\usepackage{amsthm}

\newtheorem{assumption}{Assumption}
\newtheorem{lemma}{Lemma}
\newtheorem{theorem}{Theorem}
\newtheorem{definition}{Definition}

\theoremstyle{remark}
\newtheorem*{case}{Case}

\theoremstyle{remark}
\newtheorem*{subcase}{Subcase}

\begin{document}

\special{papersize=8.5in,11in}
\setlength{\pdfpageheight}{\paperheight}
\setlength{\pdfpagewidth}{\paperwidth}

\conferenceinfo{CONF 'yy}{Month d--d, 20yy, City, ST, Country} 
\copyrightyear{20yy} 
\copyrightdata{978-1-nnnn-nnnn-n/yy/mm} 
\doi{nnnnnnn.nnnnnnn}

% Uncomment one of the following two, if you are not going for the 
% traditional copyright transfer agreement.

%\exclusivelicense                % ACM gets exclusive license to publish, 
                                  % you retain copyright

%\permissiontopublish             % ACM gets nonexclusive license to publish
                                  % (paid open-access papers, 
                                  % short abstracts)

%\titlebanner{banner above paper title}        % These are ignored unless
%\preprintfooter{short description of paper}   % 'preprint' option specified.

\title{Practical Optional Types for Clojure}

\authorinfo{Ambrose Bonnaire-Sergeant}
           {Indiana University}
           {abonnair@indiana.edu}
\authorinfo{Rowan Davies}
           {University of Western Australia}
           {rowan.davies@uwa.edu.au}
\authorinfo{Sam Tobin-Hochstadt}
           {Indiana University}
           {samth@indiana.edu}

\maketitle

\begin{abstract}
Clojure is a dynamically typed language hosted on the Java 
Virtual Machine.
Typed Racket is a valuable starting point for
a gradual type system that targets Clojure.
Building a similar type system for a new language gives the
designer some flexibility to repurpose and extend features.
This paper gives an overview of Typed Clojure, concentrating
on the extensions and differences from Typed Racket. We also
show where Typed Racket's features were particularly useful
for type checking non-trivial Clojure idioms.
\end{abstract}

\category{CR-number}{subcategory}{third-level}

% general terms are not compulsory anymore, 
% you may leave them out
%\terms
%term1, term2

\keywords
gradual types, Clojure

\section{Clojure with static typing}

% current situation 

Programming is an error prone activity, especially in the presence of
multiple languages working together. Over the past decade, it has become increasingly
frequent to extend existing dynamically typed languages with optional type systems.
The guarantees that a sound type system provides can be the difference between
choosing a language that supports a type system or one that does not.

% presenting clojure

Clojure is a dynamically typed language built to run on the Java Virtual Machine (JVM)
which has recently gained popularity as an alternative JVM language.
It offers the flexibility of a Lisp dialect, including Common Lisp-style macros,
emphasising a functional style via a standard library of immutable datastructures. 
Clojure has good interoperability with existing Java code, allowing programmers to
use existing Java libaries without leaving Clojure.

%problem?

Clojure

Typed Clojure is a gradual type system for Clojure, based on the
static portion of Typed Racket.

\begin{lstlisting}
(ann parent [(U nil File) -> (U nil File)])
(defn parent [^File f]
  (when f
    (let [s (. f (getParent))]
      (assert s "Expected parent string, got nil")
      (new File s))))
\end{lstlisting}

$$
\abs{\x{}}{\Union{\Nil}{\File}}
{\letexp {\hinted{\File{}}{f}} {f}
  {\ifexp {f} 
    {\letexp {s} {\methodstaticexp {\File{}} {\String{}} {\String{}} {getParent} {f}}
      {\doexp {\ifexp {s}
                {\nil{}}
                {\errorval{input}}}
              {\newstaticexp {\String{}} {\File{}} {\File{}} {s}}}}
    {\nil{}}
}}
              $$

%(some-> f (.getParent) (File.) (.getParent))

%\begin{lstlisting}
%(ann parent [(U nil File) -> (U nil String)])
%(defn parent [^File f]
%  (when f
%    (.getParent f)))
%\end{lstlisting}

\begin{lstlisting}
(defalias Expr
  (U '{:op :if :test Expr :then Expr :else Expr}
     '{:op :const :val Any} ...))
(ann tree-str [Expr -> String])
(defmulti tree-str (fn [e :- Expr] (get :op e)))
(defmethod tree-str :if [{:keys [test then else]}] 
  (str (tree-str test) (tree-str then) (tree-str else)))
(defmethod tree-str :const [{:keys [val]}] 
  (str val))
\end{lstlisting}


% what are the goals of Typed Clojure?
% where do they differ from Typed Racket? why?

% Things todo
% - DONE small calculus based on previous TR formalisation
%   that demos the ``flow'' environment & not/intersection type
% - discussion and examples for flow filters
% - discussion on the not/difference type, real code where it helps
% - higher-rank polymorphism, show what it enables (eg. monads)
%   - also show more complicated example, making an extensible
%     type for clojure.core/conj, and why it's not straightforward
% - discussion on limitations of local type inference
% - demonstration of how we check multimethods
% - dealing with array covariance
% - note on how we avoid null-pointer exceptions
% - discussion on why Typed Clojure only uses the ``static'' part
%   of Typed Racket
% - the equality filter problem (and draft solution?), a proposition
%   that knows about binding aliasing. Sounds straightforward?

\input{contributions}

\input{overview}

\input{formal-model}

\input{proof}

\input{syntax-figure}

\input{typing-rules}

\input{tools-analyzer-figure}

\input{subtyping}

%$$
%\begin{tdisplay}{Evaluation Contexts}
%  \begin{altgrammar}
%    \E{} &::=& [ ] % application rules
%              \alt (\c{}\ \overrightarrow{\v{}}\ \E{}\ \overrightarrow{\exp{}}) % eval arguments left-to-right
%              % map rules
%              \alt \{\overrightarrow{\v{}\ \v{}}\ \E{}\ \exp{}\ \overrightarrow{\exp{}\ \exp{}} \} % key first
%              \alt \{\overrightarrow{\v{}\ \v{}}\ \v{}\ \E{}\ \overrightarrow{\exp{}\ \exp{}} \}   % value next
%              &\mbox{Evaluation Contexts}
%  \end{altgrammar}
%\end{tdisplay}
%$$ 

\input{convert-types-figure}
\input{constant}

\input{isa-figure}
\input{get-method}

\clearpage
\input{operational-semantics}
\input{update}
\input{satisfaction}
\input{proof-system}
\input{subst}

%\appendix
%\section{Appendix Title}
%
%This is the text of the appendix, if you need one.

%\acks
%
%Acknowledgments, if needed.

% We recommend abbrvnat bibliography style.

\bibliographystyle{abbrvnat}

% The bibliography should be embedded for final submission.

\bibliography{bibliography}

%\begin{thebibliography}{}
%\softraggedright
%
%\bibitem[Smith et~al.(2009)Smith, Jones]{smith02}
%P. Q. Smith, and X. Y. Jones. ...reference text...
%
%\end{thebibliography}


\end{document}

%                       Revision History
%                       -------- -------
%  Date         Person  Ver.    Change
%  ----         ------  ----    ------

%  2013.06.29   TU      0.1--4  comments on permission/copyright notices

