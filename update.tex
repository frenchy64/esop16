\begin{figure*}
\begin{mathpar}

\begin{array}{lllll}
\update{\HMapgeneric {\mandatory} {\absent}}{\propisnotmeta{}}{\destructpath {\pathelem{}} {\keype{\k{}}}}
&=&
{\HMapgeneric {\extendmandatoryset{\mandatory}{\k{}}{\update{\t{}}{\propisnotmeta{}}{\pathelem{}}}}{\absent}}
& {\inmandatory{\k{}}{\t{}}{\mandatory{}}}
%& Present Key
\\
\update{\HMapgeneric {\mandatory} {\absent}}{\t{}}{\destructpath {\pathelem{}} {\keype{\k{}}}}
&=&
{\Bottom{}}
& {\notsubtypein {} {\Nil{}} {\t{}}}\ \text{and}\ {\inabsent{\k{}}{\absent{}}}
%& Bad absent +
\\
\update{\HMapgeneric {\mandatory} {\absent}}{\nottype{\t{}}}{\destructpath {\pathelem{}} {\keype{\k{}}}}
&=&
{\Bottom{}}
& {\issubtypein {} {\Nil{}} {\t{}}}\ \text{and}\ {\inabsent{\k{}}{\absent{}}}
%& Bad absent -
\\
\update{\HMapgeneric {\mandatory} {\absent}}{\propisnotmeta{}}{\destructpath {\pathelem{}} {\keype{\k{}}}}
&=&
{\HMapgeneric {\mandatory} {\absent}}
& {\inabsent{\k{}}{\absent{}}}
%& Consistent absent
\\
\update{\HMapp {\mandatory} {\absent}}{\t{}}{\destructpath {\pathelem{}} {\keype{\k{}}}}
&=&
{\Union {\HMapp {\extendmandatoryset {\mandatory} {\k{}}
                                     {\t{}}}
                {\absent}}
        {\HMapp {\mandatory} {\extendabsentset{\absent}{\k{}}}}}
& {\issubtypein {} {\Nil{}} {\t{}}},\ 
{\notinmandatory{\k{}}{\s{}}{\mandatory{}}}\ \text{and}\ {\notinabsent{\k{}}{\absent{}}}
\\
\update{\HMapp {\mandatory} {\absent}}{\propisnotmeta{}}{\destructpath {\pathelem{}} {\keype{\k{}}}}
&=&
{\HMapp {\extendmandatoryset {\mandatory} {\k{}}{\update{\Top}{\propisnotmeta{}}{\pathelem{}}}} {\absent}}
& 
{\notinmandatory{\k{}}{\s{}}{\mandatory{}}}\ \text{and}\ {\notinabsent{\k{}}{\absent{}}}

\\
\update{\HMapp {\mandatory} {\absent}}{\propisnotmeta{}}{\destructpath {\pathelem{}} {\keype{\k{}}}}
&=&
{\HMapp {\extendmandatoryset {\mandatory} {\k{}}{\update{\Top}{\propisnotmeta{}}{\pathelem{}}}} {\absent}}
\\
\update{\Unionsplice{{\overrightarrow{\HMapgeneric {\mandatory} {\absent}}}^i}}{\propisnotmeta{}}{\destructpath {\pathelem{}} {\keype{\k{}}}}
&=&
\Unionsplice{{\overrightarrow{\update{\HMapgeneric {\mandatory} {\absent}}{\propisnotmeta{}}{\destructpath {\pathelem{}} {\keype{\k{}}}}}}^i}


% ClassPE
\\
\update{\t{}}{\Value{\class{}}}{\destructpath{\pathelem{}}{\classpe{}}}
&=& \update{\t{}}{\class{}}{\pathelem{}}
\\
\update{\t{}}{\nottype{\Value{\class{}}}}{\destructpath{\pathelem{}}{\classpe{}}}
&=& \update{\t{}}{\nottype{\class{}}}{\pathelem{}}
& \text{if}\ \not\exists \classp{}.\ {\issubtypein{}{\classp{}}{\class{}}}\ \text{and}\ {\classp{}} \not= \class{}
\\
\update{\t{}}{\s}{\destructpath{\pathelem{}}{\classpe{}}}
&=& \update{\t{}}{\Object}{\pathelem{}}
& \text{if}\ \issubtypein{}{\s{}}{\Object{}}
\\
\update{\t{}}{\nottype{\s{}}}{\destructpath{\pathelem{}}{\classpe{}}}
&=& \update{\t{}}{\Nil{}}{\pathelem{}}
& \text{if}\ \issubtypein{}{\Object{}}{\s{}}
\\
\update{\t{}}{\s}{\destructpath{\pathelem{}}{\classpe{}}}
&=& \update{\t{}}{\Nil}{\pathelem{}}
& \text{if}\ \issubtypein{}{\s{}}{\Nil{}}
\\
\update{\t{}}{\nottype{\s{}}}{\destructpath{\pathelem{}}{\classpe{}}}
&=& \update{\t{}}{\Object}{\pathelem{}}
& \text{if}\ \issubtypein{}{\Nil{}}{\s{}}

% What if \s{} is a union of class singletons?
% this just seems wrong
%\\
%\update{\t{}}{\s{}}{\classpe{}}
%&=& \restrict{\t{}}{\s{}}
%
%\\
%\update{\t{}}{\nottype{\s{}}}{\classpe{}}
%&=& \remove{\t{}}{\s{}}

% Don't need base case covers \Top
\\
\update{\t{}}{\propisnotmeta{}}{\destructpath {\pathelem{}} {\classpe{}}}
&=& {\t{}}

\\
\update{\t{}}{\s{}}{\emptypath{}}
&=&
\restrict{\t{}}{\s{}}
\\
\update{\t{}}{\nottype{\s{}}}{\emptypath{}}
&=&
\remove{\t{}}{\s{}}


\\\\

\restrict{\t{}} {\s{}} &=& \Bot{}
                       & \text{if} \not\exists \v{}.\  
                          {\judgement {} {\hastype {\v{}} {\t{}}} {\prop{1}}{\object{1}}}
                          \ \text{and}\ 
                          {\judgement {} {\hastype {\v{}} {\s{}}} {\prop{2}}{\object{2}}}
                          \\
\restrict{\Unionsplice{\overrightarrow{{\t{}}}}}{\s{}} &=& 
\Unionsplice{\overrightarrow{\restrict{{\t{}}}{\s{}}}}
\\
\restrict{\t{}}{\s{}} &=& {\t{}} & \text{if}\ {\issubtypein {} {\t{}} {\s{}}}
\\
\restrict{\t{}}{\s{}} &=& {\s{}} & \text{otherwise}
\\\\
\remove{\t{}}{\s{}} &=& {\Bot{}} & \text{if}\ {\issubtypein {} {\t{}} {\s{}}}
\\
\remove{\Unionsplice{\overrightarrow{{\t{}}}}}{\s{}} &=& 
\Unionsplice{\overrightarrow{\remove{{\t{}}}{\s{}}}}
\\
\remove{\t{}}{\s{}} &=& {\t{}} & \text{otherwise}


\end{array}

\end{mathpar}
\caption{Type Update}
\end{figure*}

